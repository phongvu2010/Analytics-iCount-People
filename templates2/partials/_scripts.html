<script>
document.addEventListener('DOMContentLoaded', function () {
    // === DOM Elements ===
    const loadingIndicator = document.getElementById('loading-indicator');
    const filterButtons = document.querySelectorAll('.filter-btn');
    const storeSelector = document.getElementById('store-selector');
    
    // Panels & Controls
    const notificationBell = document.getElementById('notification-bell');
    const notificationPanel = document.getElementById('notification-panel');
    const errorLogContainer = document.getElementById('error-log-container');
    const settingsButton = document.getElementById('settings-button');
    const settingsPanel = document.getElementById('settings-panel');
    const themeSelector = document.getElementById('theme-selector');
    const themeButtons = document.querySelectorAll('.theme-btn');
    const smoothingSlider = document.getElementById('smoothing-slider');
    const timeRangeDisplay = document.getElementById('time-range-display');
    const downloadCsvButton = document.getElementById('download-csv-button');
    const paginationControls = document.getElementById('pagination-controls');
    const tableBody = document.getElementById('data-table-body');
    
    // Filter Containers & Inputs
    const yearFilterContainer = document.getElementById('year-filter-container');
    const monthFilterContainer = document.getElementById('month-filter-container');
    const weekFilterContainer = document.getElementById('week-filter-container');
    const dayFilterContainer = document.getElementById('day-filter-container');
    const yearSelector = document.getElementById('year-selector');
    const monthYearSelector = document.getElementById('month-year-selector');
    const monthSelector = document.getElementById('month-selector');
    const weekYearSelector = document.getElementById('week-year-selector');
    const weekSelector = document.getElementById('week-selector');
    const datePicker = document.getElementById('date-picker');

    // === Chart instances ===
    let trafficChart, storeComparisonChart;

    // === State management ===
    const state = {
        period: 'year', // Default period
        store: 'all',
        year: new Date().getFullYear(),
        month: new Date().getMonth() + 1, // JS month is 0-11, we use 1-12
        week: dateFns.getISOWeek(new Date()),
        date: new Date(),
        page: 1,
        pageSize: 10
    };

    // === Helper Functions ===
    const formatDate = (date) => date.toISOString().split('T')[0];
    const showLoading = () => loadingIndicator.classList.remove('hidden');
    const hideLoading = () => loadingIndicator.classList.add('hidden');

    // === Main Data Fetching & UI Update ===
    async function fetchDashboardData() {
        showLoading();
        const { startDate, endDate } = calculateDateRange();
        timeRangeDisplay.textContent = `Từ ${formatDate(startDate)} đến ${formatDate(endDate)}`;

        const params = new URLSearchParams({
            period: state.period,
            start_date: formatDate(startDate),
            end_date: formatDate(endDate),
            store: state.store,
            page: state.page,
            page_size: state.pageSize
        });
        
        try {
            const response = await fetch(`/api/v1/dashboard?${params.toString()}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            updateUI(data);
        } catch (error) {
            console.error('Failed to fetch dashboard data:', error);
            alert('Đã xảy ra lỗi khi tải dữ liệu. Vui lòng kiểm tra console.');
        } finally {
            hideLoading();
        }
    }

    function calculateDateRange() {
        const year = state.year;
        switch (state.period) {
            case 'year':
                return { startDate: new Date(year, 0, 1), endDate: new Date(year, 11, 31) };
            case 'month':
                const month = state.month - 1; // Convert back to 0-indexed for Date object
                return { startDate: new Date(year, month, 1), endDate: new Date(year, month + 1, 0) };
            case 'week':
                const weekStart = dateFns.startOfWeek(dateFns.setISOWeek(new Date(year, 0, 4), state.week), { weekStartsOn: 1 });
                const weekEnd = dateFns.endOfWeek(weekStart, { weekStartsOn: 1 });
                return { startDate: weekStart, endDate: weekEnd };
            case 'day':
                return { startDate: state.date, endDate: state.date };
            default:
                return { startDate: new Date(), endDate: new Date() };
        }
    }
    
    function updateUI(data) {
        // Metrics
        document.getElementById('total-in').textContent = data.metrics.total_in.toLocaleString() || '0';
        document.getElementById('average-in').textContent = data.metrics.average_in.toLocaleString() || '0';
        document.getElementById('peak-time').textContent = data.metrics.peak_time || '--:--';
        document.getElementById('occupancy').textContent = data.metrics.current_occupancy.toLocaleString() || '0';
        document.getElementById('busiest-store').textContent = data.metrics.busiest_store || '--';
        const growthElem = document.getElementById('growth');
        growthElem.innerHTML = `<span>${data.metrics.growth > 0 ? '▲' : '▼'} ${Math.abs(data.metrics.growth)}%</span>`;
        growthElem.classList.toggle('text-green-500', data.metrics.growth > 0);
        growthElem.classList.toggle('text-red-500', data.metrics.growth <= 0);

        // Charts
        trafficChart.data.labels = data.trend_chart.series.map(d => d.x);
        trafficChart.data.datasets[0].data = data.trend_chart.series.map(d => d.y);
        let timeUnit = 'day';
        if (state.period === 'year') timeUnit = 'month';
        if (state.period === 'day') timeUnit = 'hour';
        trafficChart.options.scales.x.time.unit = timeUnit;
        trafficChart.update();
        
        storeComparisonChart.data.labels = data.store_comparison_chart.series.map(d => d.x);
        storeComparisonChart.data.datasets[0].data = data.store_comparison_chart.series.map(d => d.y);
        storeComparisonChart.update();

        // Table and Notifications
        updateTable(data.table_data);
        updateErrorNotifications(data.error_logs);
    }

    function updateTable(tableData) {
        tableBody.innerHTML = '';
        if (!tableData || tableData.data.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="4" class="text-center p-4">Không có dữ liệu.</td></tr>`;
            paginationControls.innerHTML = '';
            return;
        }
        tableData.data.forEach(row => {
            const tr = document.createElement('tr');
            tr.className = 'bg-white dark:bg-gray-800 border-b dark:border-gray-700 hover:bg-slate-50 dark:hover:bg-gray-600';
            tr.innerHTML = `<td class="px-6 py-4">${new Date(row.record_time).toLocaleString('vi-VN')}</td><td class="px-6 py-4">${row.store_name}</td><td class="px-6 py-4 font-medium text-slate-900 dark:text-white">${row.in_count}</td><td class="px-6 py-4">${row.out_count}</td>`;
            tableBody.appendChild(tr);
        });
        updatePagination(tableData.total_records, tableData.page, tableData.page_size);
    }
    
    function updatePagination(totalRecords, page, pageSize) {
        const totalPages = Math.ceil(totalRecords / pageSize);
        if (totalPages <= 1) {
            paginationControls.innerHTML = '';
            return;
        }
        paginationControls.innerHTML = `
            <span class="text-sm text-slate-500 dark:text-slate-400">
                Hiển thị ${pageSize * (page - 1) + 1}-${Math.min(pageSize * page, totalRecords)} của ${totalRecords}
            </span>
            <div class="inline-flex mt-2 xs:mt-0">
                <button ${page === 1 ? 'disabled' : ''} data-page="${page-1}" class="page-btn px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-l hover:bg-blue-700 disabled:bg-gray-500 disabled:cursor-not-allowed">Trước</button>
                <button ${page >= totalPages ? 'disabled' : ''} data-page="${page+1}" class="page-btn px-4 py-2 text-sm font-medium text-white bg-blue-600 border-0 border-l border-gray-700 rounded-r hover:bg-blue-700 disabled:bg-gray-500 disabled:cursor-not-allowed">Sau</button>
            </div>
        `;
        document.querySelectorAll('.page-btn').forEach(button => {
            if (!button.disabled) {
                button.addEventListener('click', (e) => {
                    state.page = parseInt(e.currentTarget.dataset.page);
                    fetchDashboardData();
                });
            }
        });
    }

    function updateErrorNotifications(errors) {
        const badge = document.getElementById('notification-badge');
        const container = document.getElementById('error-log-container');
        if(errors && errors.length > 0) {
            badge.textContent = errors.length;
            badge.classList.remove('hidden');
            container.innerHTML = errors.map(err => `
                <div class="p-3 rounded-lg bg-red-100 dark:bg-red-900/50">
                    <p class="text-sm font-semibold text-red-800 dark:text-red-300">[${err.store_name}] - ${new Date(err.log_time).toLocaleString('vi-VN')}</p>
                    <p class="text-xs text-red-600 dark:text-red-400 mt-1">${err.error_code}: ${err.error_message}</p>
                </div>
            `).join('');
        } else {
            badge.classList.add('hidden');
            container.innerHTML = '<p class="text-center p-4 text-slate-500">Không có cảnh báo mới.</p>';
        }
    }

    // === Dynamic Filter UI Management ===
    function updateFilterUI() {
        [yearFilterContainer, monthFilterContainer, weekFilterContainer, dayFilterContainer].forEach(c => c.style.display = 'none');
        switch (state.period) {
            case 'year':
                yearFilterContainer.style.display = 'block';
                populateYearSelector(yearSelector, state.year);
                break;
            case 'month':
                monthFilterContainer.style.display = 'flex';
                populateYearSelector(monthYearSelector, state.year);
                populateMonthSelector(monthSelector, state.month);
                break;
            case 'week':
                weekFilterContainer.style.display = 'flex';
                populateYearSelector(weekYearSelector, state.year);
                populateWeekSelector(weekSelector, state.year, state.week);
                break;
            case 'day':
                dayFilterContainer.style.display = 'block';
                datePicker.value = formatDate(state.date);
                break;
        }
    }

    function populateYearSelector(selector, selectedYear) {
        const currentYear = new Date().getFullYear();
        selector.innerHTML = '';
        for (let y = currentYear; y >= 2018; y--) {
            selector.add(new Option(y, y));
        }
        selector.value = selectedYear;
    }

    function populateMonthSelector(selector, selectedMonth) {
        selector.innerHTML = '';
        for (let m = 1; m <= 12; m++) {
            selector.add(new Option(new Date(2000, m - 1, 1).toLocaleString('vi-VN', { month: 'long' }), m));
        }
        selector.value = selectedMonth;
    }

    function populateWeekSelector(selector, year, selectedWeek) {
        selector.innerHTML = '';
        const totalWeeks = dateFns.getISOWeeksInYear(new Date(year, 0, 1));
        for (let w = 1; w <= totalWeeks; w++) {
            const weekStart = dateFns.startOfWeek(dateFns.setISOWeek(new Date(year, 0, 4), w), { weekStartsOn: 1 });
            const weekEnd = dateFns.endOfWeek(weekStart, { weekStartsOn: 1 });
            selector.add(new Option(`Tuần ${w} (${formatDate(weekStart)} - ${formatDate(weekEnd)})`, w));
        }
        selector.value = selectedWeek;
    }

    function exportTableToCSV(filename) {
        let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // BOM for Vietnamese Excel
        const rows = document.querySelectorAll("table tr");
        rows.forEach(row => {
            const rowData = [];
            row.querySelectorAll("th, td").forEach(cell => {
                let cellData = cell.innerText.replace(/"/g, '""');
                rowData.push(`"${cellData}"`);
            });
            csvContent += rowData.join(",") + "\r\n";
        });
        const link = document.createElement("a");
        link.setAttribute("href", encodeURI(csvContent));
        link.setAttribute("download", filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    // === Theme Management & Charting ===
    function applyTheme(theme) {
        if (theme === 'dark') {
            document.documentElement.classList.add('dark');
            localStorage.theme = 'dark';
        } else if (theme === 'light') {
            document.documentElement.classList.remove('dark');
            localStorage.theme = 'light';
        } else {
            localStorage.removeItem('theme');
            if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }
        updateThemeButtons(theme);
    }

    function updateThemeButtons(currentTheme) {
        themeButtons.forEach(button => {
            if (button.dataset.theme === currentTheme) {
                button.classList.add('bg-blue-600', 'text-white');
                button.classList.remove('dark:hover:bg-gray-700', 'hover:bg-slate-200');
            } else {
                button.classList.remove('bg-blue-600', 'text-white');
                button.classList.add('dark:hover:bg-gray-700', 'hover:bg-slate-200');
            }
        });
    }

    function initializeCharts() {
        const initialTension = parseFloat(localStorage.getItem('chartTension')) || 0.1;
        smoothingSlider.value = initialTension;

        // Traffic Chart (Line)
        const trafficCtx = document.getElementById('trafficChart').getContext('2d');
        trafficChart = new Chart(trafficCtx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Lượt vào', data: [], borderColor: '#3b82f6', borderWidth: 2, tension: initialTension, pointBackgroundColor: '#3b82f6' }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'day' } }, y: { beginAtZero: true } } }
        });

        // Store Comparison Chart (Doughnut)
        const storeCtx = document.getElementById('storeComparisonChart').getContext('2d');
        storeComparisonChart = new Chart(storeCtx, {
            type: 'doughnut',
            data: { labels: [], datasets: [{ data: [], backgroundColor: ['#3b82f6', '#ef4444', '#10b981', '#f97316', '#8b5cf6'] }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
    }

    // === Initializers & Event Listeners ===
    function setupEventListeners() {
        // Period Buttons
        filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                filterButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                state.period = button.dataset.period;
                state.page = 1; // Reset page on filter change
                // Reset to current time when changing period type
                state.year = new Date().getFullYear();
                state.month = new Date().getMonth() + 1;
                state.week = dateFns.getISOWeek(new Date());
                state.date = new Date();
                
                updateFilterUI();
                fetchDashboardData();
            });
        });

        // Dynamic Filter Inputs
        const commonChangeHandler = () => { state.page = 1; fetchDashboardData(); };
        storeSelector.addEventListener('change', (e) => { state.store = e.target.value; commonChangeHandler(); });
        yearSelector.addEventListener('change', (e) => { state.year = parseInt(e.target.value); commonChangeHandler(); });
        monthYearSelector.addEventListener('change', (e) => { state.year = parseInt(e.target.value); commonChangeHandler(); });
        monthSelector.addEventListener('change', (e) => { state.month = parseInt(e.target.value); commonChangeHandler(); });
        weekYearSelector.addEventListener('change', (e) => { state.year = parseInt(e.target.value); populateWeekSelector(weekSelector, state.year, 1); state.week = 1; commonChangeHandler(); });
        weekSelector.addEventListener('change', (e) => { state.week = parseInt(e.target.value); commonChangeHandler(); });
        datePicker.addEventListener('change', (e) => { state.date = new Date(e.target.value); commonChangeHandler(); });
        
        // Download CSV
        downloadCsvButton.addEventListener('click', () => {
            const { startDate, endDate } = calculateDateRange();
            const filename = `export_data_${formatDate(startDate)}_to_${formatDate(endDate)}.csv`;
            exportTableToCSV(filename);
        });

        // Settings & Theme Listeners
        notificationBell.addEventListener('click', () => { notificationPanel.classList.toggle('hidden'); settingsPanel.classList.add('hidden'); });
        settingsButton.addEventListener('click', () => { settingsPanel.classList.toggle('hidden'); notificationPanel.classList.add('hidden'); });
        themeSelector.addEventListener('click', (e) => { if (e.target.matches('.theme-btn')) applyTheme(e.target.dataset.theme); });
        smoothingSlider.addEventListener('input', (e) => {
            const newTension = parseFloat(e.target.value);
            if (trafficChart) {
                trafficChart.data.datasets[0].tension = newTension;
                trafficChart.update();
                localStorage.setItem('chartTension', newTension);
            }
        });
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => { if (!('theme' in localStorage)) applyTheme('auto'); });
    }

    async function initializeApp() {
        const savedTheme = localStorage.theme || 'auto';
        applyTheme(savedTheme);
        updateThemeButtons(savedTheme);
        
        initializeCharts();
        
        try {
            const response = await fetch('/api/v1/stores');
            if (!response.ok) throw new Error('Network response was not ok');
            const stores = await response.json();
            storeSelector.innerHTML = '<option value="all">Tất cả cửa hàng</option>';
            stores.forEach(store => storeSelector.add(new Option(store, store)));
        } catch (error) {
            console.error('Failed to fetch stores:', error);
            storeSelector.innerHTML = '<option value="all">Lỗi tải DS cửa hàng</option>';
        }

        setupEventListeners();
        updateFilterUI();
        fetchDashboardData();
    }

    initializeApp();
});
</script>
