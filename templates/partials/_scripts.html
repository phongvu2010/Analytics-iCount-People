<script>
document.addEventListener('DOMContentLoaded', function () {
    // === DOM Elements ===
    const loadingIndicator = document.getElementById('loading-indicator');
    const storeSelector = document.getElementById('store-selector');
    const datePickerContainer = document.getElementById('date-picker-container');
    const filterButtons = document.querySelectorAll('.filter-btn');
    const notificationBell = document.getElementById('notification-bell');
    const notificationBadge = document.getElementById('notification-badge');
    const notificationPanel = document.getElementById('notification-panel');
    const errorLogContainer = document.getElementById('error-log-container');
    
    // === Chart instances ===
    let trafficChart, storeComparisonChart;

    // === State management ===
    const state = {
        startDate: new Date(),
        endDate: new Date(),
        store: 'all',
        period: 'day',
        page: 1,
        pageSize: 10
    };

    // === Helper Functions ===
    const formatDate = (date) => date.toISOString().split('T')[0];

    const showLoading = () => loadingIndicator.classList.remove('hidden');
    const hideLoading = () => loadingIndicator.classList.add('hidden');

    // === Chart Setup ===
    function initializeCharts() {
        // Traffic Chart (Line)
        const trafficCtx = document.getElementById('trafficChart').getContext('2d');
        trafficChart = new Chart(trafficCtx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Lượt vào', data: [], borderColor: '#3b82f6', borderWidth: 2, tension: 0.1, pointBackgroundColor: '#3b82f6' }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'hour' } }, y: { beginAtZero: true } } }
        });

        // Store Comparison Chart (Doughnut)
        const storeCtx = document.getElementById('storeComparisonChart').getContext('2d');
        storeComparisonChart = new Chart(storeCtx, {
            type: 'doughnut',
            data: { labels: [], datasets: [{ data: [], backgroundColor: ['#3b82f6', '#ef4444', '#10b981', '#f97316', '#8b5cf6'] }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
    }

    // === Data Fetching & UI Update ===
    async function fetchDashboardData() {
        showLoading();
        const params = new URLSearchParams({
            start_date: formatDate(state.startDate),
            end_date: formatDate(state.endDate),
            store: state.store,
            page: state.page,
            page_size: state.pageSize
        });
        
        try {
            const response = await fetch(`/api/v1/dashboard?${params.toString()}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();

            updateUI(data);

        } catch (error) {
            console.error('Failed to fetch dashboard data:', error);
            // Optionally show an error message to the user
        } finally {
            hideLoading();
        }
    }

    function updateUI(data) {
        // Metrics
        document.getElementById('total-in').textContent = data.metrics.total_in.toLocaleString() || '0';
        document.getElementById('average-in').textContent = data.metrics.average_in.toLocaleString() || '0';
        document.getElementById('peak-time').textContent = data.metrics.peak_time || '--:--';
        document.getElementById('occupancy').textContent = data.metrics.current_occupancy.toLocaleString() || '0';
        document.getElementById('busiest-store').textContent = data.metrics.busiest_store || '--';
        document.getElementById('growth').innerHTML = `<span>${data.metrics.growth > 0 ? '▲' : '▼'} ${Math.abs(data.metrics.growth)}%</span>`;
        document.getElementById('growth').classList.toggle('text-green-500', data.metrics.growth > 0);
        document.getElementById('growth').classList.toggle('text-red-500', data.metrics.growth <= 0);

        // Charts
        trafficChart.data.labels = data.trend_chart.series.map(d => d.x);
        trafficChart.data.datasets[0].data = data.trend_chart.series.map(d => d.y);
        trafficChart.options.scales.x.time.unit = state.period === 'year' ? 'month' : (state.period === 'month' || state.period === 'week' ? 'day' : 'hour');
        trafficChart.update();

        storeComparisonChart.data.labels = data.store_comparison_chart.series.map(d => d.x);
        storeComparisonChart.data.datasets[0].data = data.store_comparison_chart.series.map(d => d.y);
        storeComparisonChart.update();

        // Table
        updateTable(data.table_data);

        // Notifications
        updateErrorNotifications(data.error_logs);
    }

    function updateTable(tableData) {
        const tableBody = document.getElementById('data-table-body');
        tableBody.innerHTML = ''; // Clear existing rows
        if (tableData.data.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="4" class="text-center p-4">Không có dữ liệu.</td></tr>`;
            return;
        }
        tableData.data.forEach(row => {
            const tr = document.createElement('tr');
            tr.className = 'bg-white dark:bg-gray-800 border-b dark:border-gray-700 hover:bg-slate-50 dark:hover:bg-gray-600';
            tr.innerHTML = `
                <td class="px-6 py-4">${new Date(row.record_time).toLocaleString('vi-VN')}</td>
                <td class="px-6 py-4">${row.store_name}</td>
                <td class="px-6 py-4 font-medium text-slate-900 dark:text-white">${row.in_count}</td>
                <td class="px-6 py-4">${row.out_count}</td>
            `;
            tableBody.appendChild(tr);
        });
        updatePagination(tableData.total_records, tableData.page, tableData.page_size);
    }
    
    function updatePagination(totalRecords, page, pageSize) {
        const paginationControls = document.getElementById('pagination-controls');
        const totalPages = Math.ceil(totalRecords / pageSize);
        paginationControls.innerHTML = `
            <span class="text-sm text-slate-500 dark:text-slate-400">
                Hiển thị ${pageSize * (page - 1) + 1}-${Math.min(pageSize * page, totalRecords)} của ${totalRecords}
            </span>
            <div class="inline-flex mt-2 xs:mt-0">
                <button ${page === 1 ? 'disabled' : ''} data-page="${page-1}" class="page-btn px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-l hover:bg-blue-700 disabled:bg-gray-500 disabled:cursor-not-allowed">Prev</button>
                <button ${page >= totalPages ? 'disabled' : ''} data-page="${page+1}" class="page-btn px-4 py-2 text-sm font-medium text-white bg-blue-600 border-0 border-l border-gray-700 rounded-r hover:bg-blue-700 disabled:bg-gray-500 disabled:cursor-not-allowed">Next</button>
            </div>
        `;
        document.querySelectorAll('.page-btn').forEach(button => {
            if (!button.disabled) {
                button.addEventListener('click', (e) => {
                    state.page = parseInt(e.currentTarget.dataset.page);
                    fetchDashboardData();
                });
            }
        });
    }

    function updateErrorNotifications(errors) {
        if(errors.length > 0) {
            notificationBadge.textContent = errors.length;
            notificationBadge.classList.remove('hidden');
        } else {
            notificationBadge.classList.add('hidden');
        }
        errorLogContainer.innerHTML = '';
        errors.forEach(err => {
            const errorEl = document.createElement('div');
            errorEl.className = 'p-3 rounded-lg bg-red-100 dark:bg-red-900/50';
            errorEl.innerHTML = `
                <p class="text-sm font-semibold text-red-800 dark:text-red-300">[${err.store_name}] - ${new Date(err.log_time).toLocaleString('vi-VN')}</p>
                <p class="text-xs text-red-600 dark:text-red-400 mt-1">${err.error_code}: ${err.error_message}</p>
            `;
            errorLogContainer.appendChild(errorEl);
        });
    }

    // === Initializers ===
    async function initializeFilters() {
        // Date Pickers
        datePickerContainer.innerHTML = `
            <input type="date" id="start-date" class="h-10 w-full sm:w-auto bg-white dark:bg-gray-700 border border-slate-300 dark:border-gray-600 rounded-lg px-3 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none">
            <input type="date" id="end-date" class="h-10 w-full sm:w-auto bg-white dark:bg-gray-700 border border-slate-300 dark:border-gray-600 rounded-lg px-3 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none">
        `;
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        
        startDateInput.value = formatDate(state.startDate);
        endDateInput.value = formatDate(state.endDate);

        startDateInput.addEventListener('change', (e) => { state.startDate = new Date(e.target.value); fetchDashboardData(); });
        endDateInput.addEventListener('change', (e) => { state.endDate = new Date(e.target.value); fetchDashboardData(); });

        // Store Selector
        try {
            const response = await fetch('/api/v1/stores');
            const stores = await response.json();
            storeSelector.innerHTML = '<option value="all">Tất cả cửa hàng</option>';
            stores.forEach(store => {
                const option = document.createElement('option');
                option.value = store;
                option.textContent = store;
                storeSelector.appendChild(option);
            });
            storeSelector.addEventListener('change', (e) => { state.store = e.target.value; fetchDashboardData(); });
        } catch (error) {
            console.error('Failed to fetch stores:', error);
        }
    }

    function setupEventListeners() {
        filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                filterButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                state.period = button.dataset.period;
                
                const now = new Date();
                switch(state.period) {
                    case 'day':
                        state.startDate = new Date();
                        state.endDate = new Date();
                        break;
                    case 'week':
                        state.startDate = new Date(now.setDate(now.getDate() - now.getDay()));
                        state.endDate = new Date();
                        break;
                    case 'month':
                        state.startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        state.endDate = new Date();
                        break;
                    case 'year':
                        state.startDate = new Date(now.getFullYear(), 0, 1);
                        state.endDate = new Date();
                        break;
                }
                document.getElementById('start-date').value = formatDate(state.startDate);
                document.getElementById('end-date').value = formatDate(state.endDate);
                fetchDashboardData();
            });
        });

        notificationBell.addEventListener('click', () => {
            notificationPanel.classList.toggle('hidden');
        });
    }

    async function initializeApp() {
        initializeCharts();
        await initializeFilters();
        setupEventListeners();
        fetchDashboardData(); // Initial data load
    }

    initializeApp();
});
</script>
