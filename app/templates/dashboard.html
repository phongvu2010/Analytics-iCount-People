<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ project_name }}</title>
    <!-- Tailwind CSS CDN -->
    <script src="[https://cdn.tailwindcss.com](https://cdn.tailwindcss.com)"></script>
    <!-- Chart.js CDN -->
    <script src="[https://cdn.jsdelivr.net/npm/chart.js](https://cdn.jsdelivr.net/npm/chart.js)"></script>
    <script src="[https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns](https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns)"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="[https://fonts.googleapis.com](https://fonts.googleapis.com)">
    <link rel="preconnect" href="[https://fonts.gstatic.com](https://fonts.gstatic.com)" crossorigin>
    <link href="[https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap](https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap)" rel="stylesheet">
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <script>
        // Set theme on initial load
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        .dark ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .filter-btn.active {
            background-color: #2563eb;
            color: white;
            font-weight: 600;
        }
        .custom-select {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem;
        }
        .dark .custom-select {
             background-image: url("data:image/svg+xml,%3csvg xmlns='[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        }
        input[type="date"]::-webkit-calendar-picker-indicator { cursor: pointer; filter: invert(0.5); }
        .dark input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); }
    </style>
</head>
<body class="bg-slate-50 dark:bg-gray-900 text-slate-800 dark:text-slate-200 transition-colors duration-300">

    <div class="container mx-auto p-4 md:p-6 lg:p-8">
        <header class="mb-6 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <img src="/static/logo.png" alt="Logo" class="h-10" onerror="this.style.display='none'">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-slate-900 dark:text-white">{{ project_name }}</h1>
                    <p class="text-slate-500 dark:text-slate-400 mt-1 text-sm sm:text-base">{{ description }}</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <!-- Notification Bell -->
                <div class="relative">
                    <button id="notification-bell" class="text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-white transition-colors">
                        <svg xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z" /></svg>
                        <span id="notification-badge" class="absolute -top-1 -right-1 flex h-5 w-5 items-center justify-center rounded-full bg-red-600 text-xs font-bold text-white">0</span>
                    </button>
                    <div id="notification-panel" class="hidden absolute top-full right-0 mt-2 w-80 sm:w-96 bg-white dark:bg-gray-800 rounded-xl shadow-2xl border border-slate-200 dark:border-gray-700 z-50">
                        <div class="p-4 border-b border-slate-200 dark:border-gray-700"><h3 class="font-semibold text-slate-900 dark:text-white">Cảnh Báo Hệ Thống</h3></div>
                        <div id="error-log-container" class="p-2 space-y-2 overflow-y-auto" style="max-height: 400px;"></div>
                    </div>
                </div>
            </div>
        </header>

        <main class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-2xl shadow-lg">
            <!-- Filters -->
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6 pb-6 border-b border-slate-200 dark:border-gray-700">
                <div class="flex items-center gap-2 flex-wrap">
                    <button data-period="day" class="filter-btn px-4 py-2 text-sm rounded-lg bg-slate-200 dark:bg-gray-700 hover:bg-slate-300 dark:hover:bg-gray-600 transition-colors active">Ngày</button>
                    <button data-period="week" class="filter-btn px-4 py-2 text-sm rounded-lg bg-slate-200 dark:bg-gray-700 hover:bg-slate-300 dark:hover:bg-gray-600 transition-colors">Tuần</button>
                    <button data-period="month" class="filter-btn px-4 py-2 text-sm rounded-lg bg-slate-200 dark:bg-gray-700 hover:bg-slate-300 dark:hover:bg-gray-600 transition-colors">Tháng</button>
                    <button data-period="year" class="filter-btn px-4 py-2 text-sm rounded-lg bg-slate-200 dark:bg-gray-700 hover:bg-slate-300 dark:hover:bg-gray-600 transition-colors">Năm</button>
                </div>
                <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center">
                    <select id="store-selector" class="h-10 custom-select w-full sm:w-auto bg-white dark:bg-gray-700 border border-slate-300 dark:border-gray-600 rounded-lg px-3 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none"></select>
                    <input type="date" id="date-selector" class="h-10 custom-select bg-white dark:bg-gray-700 border border-slate-300 dark:border-gray-600 rounded-lg px-3 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none w-full sm:w-40">
                </div>
            </div>
            
            <!-- Metrics -->
            <div class="grid grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                <div class="bg-slate-100 dark:bg-gray-700/50 p-4 rounded-xl"><h3 class="text-sm font-medium text-slate-500 dark:text-slate-400">Tổng Lượt Vào</h3><p id="total-in" class="text-2xl xl:text-3xl font-bold text-slate-900 dark:text-white mt-1">0</p></div>
                <div class="bg-slate-100 dark:bg-gray-700/50 p-4 rounded-xl"><h3 class="text-sm font-medium text-slate-500 dark:text-slate-400">Lượt vào TB</h3><p id="average-in" class="text-2xl xl:text-3xl font-bold text-slate-900 dark:text-white mt-1">0</p></div>
                <div class="bg-slate-100 dark:bg-gray-700/50 p-4 rounded-xl"><h3 class="text-sm font-medium text-slate-500 dark:text-slate-400">Giờ Cao Điểm</h3><p id="peak-time" class="text-2xl xl:text-3xl font-bold text-slate-900 dark:text-white mt-1">--:--</p></div>
                <div class="bg-slate-100 dark:bg-gray-700/50 p-4 rounded-xl"><h3 class="text-sm font-medium text-slate-500 dark:text-slate-400">Số người hiện tại (Ước tính)</h3><p id="occupancy" class="text-2xl xl:text-3xl font-bold text-slate-900 dark:text-white mt-1">0</p></div>
                <div class="bg-slate-100 dark:bg-gray-700/50 p-4 rounded-xl"><h3 class="text-sm font-medium text-slate-500 dark:text-slate-400">Tăng trưởng</h3><div id="growth" class="text-2xl xl:text-3xl font-bold text-slate-900 dark:text-white mt-1 flex items-center gap-2"><span>--</span></div></div>
            </div>

            <!-- Main Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 mb-8">
                <div class="lg:col-span-3"><h3 class="text-xl font-semibold text-slate-900 dark:text-white mb-4">Xu hướng lượt vào</h3><div class="h-96"><canvas id="trafficChart"></canvas></div></div>
                <div id="pie-chart-wrapper" class="lg:col-span-2"><h3 class="text-xl font-semibold text-slate-900 dark:text-white mb-4">Tỷ trọng theo cửa</h3><div class="h-96 bg-slate-100 dark:bg-gray-700/50 p-4 rounded-xl flex items-center justify-center"><canvas id="storeComparisonChart"></canvas></div></div>
            </div>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- UI ELEMENT REFERENCES ---
        const ui = {
            chartCanvas: document.getElementById('trafficChart'),
            storeComparisonCanvas: document.getElementById('storeComparisonChart'),
            filterButtons: document.querySelectorAll('.filter-btn'),
            timeRangeDisplay: document.getElementById('time-range-display'),
            totalInDisplay: document.getElementById('total-in'),
            averageInDisplay: document.getElementById('average-in'),
            peakTimeDisplay: document.getElementById('peak-time'),
            occupancyDisplay: document.getElementById('occupancy'),
            growthDisplay: document.getElementById('growth'),
            storeSelector: document.getElementById('store-selector'),
            dateSelector: document.getElementById('date-selector'),
            notification: { bell: document.getElementById('notification-bell'), badge: document.getElementById('notification-badge'), panel: document.getElementById('notification-panel'), logContainer: document.getElementById('error-log-container')},
        };

        let trafficChart, storeComparisonChart;
        let currentPeriod = 'day';

        // --- HELPER FUNCTIONS ---
        const formatDate = (date, locale = 'sv-SE') => date.toLocaleDateString(locale);
        const showLoading = (isLoading) => { document.body.style.cursor = isLoading ? 'wait' : 'default'; };

        // --- API FETCH FUNCTIONS ---
        async function fetchData(endpoint) {
            showLoading(true);
            try {
                const response = await fetch(`/api/v1/${endpoint}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Error fetching ${endpoint}:`, error);
                alert(`Không thể tải dữ liệu: ${error.message}`);
                return null;
            } finally {
                showLoading(false);
            }
        }

        // --- UI POPULATION & INTERACTION ---
        async function populateStoreSelector() {
            const stores = await fetchData('analytics/stores');
            if (!stores) return;
            ui.storeSelector.innerHTML = `<option value="">Tất cả cửa</option>`;
            stores.forEach(store => {
                ui.storeSelector.innerHTML += `<option value="${store.store_name}">${store.store_name}</option>`;
            });
        }
        
        function setupPopups() {
            const setupPopup = (button, panel) => { button.addEventListener('click', (e) => { e.stopPropagation(); panel.classList.toggle('hidden'); }); };
            setupPopup(ui.notification.bell, ui.notification.panel);
            document.addEventListener('click', (e) => {
                if (!ui.notification.panel.classList.contains('hidden') && !ui.notification.panel.contains(e.target) && !ui.notification.bell.contains(e.target)) {
                    ui.notification.panel.classList.add('hidden');
                }
            });
        }

        async function setupNotifications() {
            const errorLogs = await fetchData('errors/');
            if (!errorLogs) return;

            ui.notification.badge.textContent = errorLogs.length;
            if (errorLogs.length > 0) ui.notification.badge.classList.remove('hidden'); else ui.notification.badge.classList.add('hidden');
            
            ui.notification.logContainer.innerHTML = errorLogs.length === 0 
                ? `<div class="text-center text-slate-500 dark:text-slate-400 p-4">Không có cảnh báo nào.</div>` 
                : errorLogs.map(log => {
                    const logTime = new Date(log.log_time).toLocaleString('vi-VN');
                    return `<div class="flex items-start gap-3 p-3 mx-2 mb-2 bg-red-500/10 border-l-4 border-red-500 rounded-r-lg">
                                <div class="flex-shrink-0 pt-1"><svg xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-4a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd" /></svg></div>
                                <div><p class="font-semibold text-sm text-slate-800 dark:text-white">${log.error_message} - ${log.store_name}</p><p class="text-xs text-slate-500 dark:text-slate-400">${logTime}</p></div>
                            </div>`;
                }).join('');
        }

        // --- CHARTING ---
        const getChartColors = () => {
            const isDark = document.documentElement.classList.contains('dark');
            return { grid: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)', ticks: isDark ? '#94a3b8' : '#64748b', tooltipBg: isDark ? '#1e293b' : '#ffffff', tooltipText: isDark ? '#f1f5f9' : '#1e293b' };
        };

        function initOrUpdateChart(chartInstance, canvas, type, data, options) {
            if (chartInstance) {
                chartInstance.data = data;
                chartInstance.options = options;
                chartInstance.update();
            } else {
                const ctx = canvas.getContext('2d');
                return new Chart(ctx, { type, data, options });
            }
        }

        // --- MAIN DASHBOARD UPDATE LOGIC ---
        async function updateDashboard() {
            const date = ui.dateSelector.value;
            const storeName = ui.storeSelector.value;
            let queryParams = `period=${currentPeriod}&date=${date}`;
            if (storeName) queryParams += `&store_name=${encodeURIComponent(storeName)}`;

            const [timeSeries, summary, distribution] = await Promise.all([
                fetchData(`analytics/timeseries?${queryParams}`),
                fetchData(`analytics/summary?${queryParams}`),
                fetchData(`analytics/store-distribution?period=${currentPeriod}&date=${date}`)
            ]);
            
            // Update Metrics
            if (summary) {
                ui.totalInDisplay.textContent = summary.total_in.toLocaleString('vi-VN');
                ui.averageInDisplay.textContent = summary.average_in.toLocaleString('vi-VN', { maximumFractionDigits: 0 });
                ui.peakTimeDisplay.textContent = summary.peak_time;
                ui.occupancyDisplay.textContent = summary.occupancy.toLocaleString('vi-VN');
                const growth = summary.growth;
                const growthColor = growth > 0 ? 'text-green-500' : growth < 0 ? 'text-red-500' : 'text-slate-500';
                const growthIcon = growth > 0 ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>` : growth < 0 ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12" /></svg>` : '';
                ui.growthDisplay.className = `text-2xl xl:text-3xl font-bold mt-1 flex items-center gap-2 ${growthColor}`;
                ui.growthDisplay.innerHTML = `<span>${growth.toFixed(1)}%</span> ${growthIcon}`;
            }

            // Update Line Chart
            const colors = getChartColors();
            const lineChartOptions = { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: colors.grid }, ticks: { color: colors.ticks } }, x: { grid: { display: false }, ticks: { color: colors.ticks } } }, plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false, backgroundColor: colors.tooltipBg, titleColor: colors.tooltipText, bodyColor: colors.tooltipText, titleFont: { weight: 'bold' }, bodySpacing: 4, padding: 12, cornerRadius: 8, borderColor: colors.grid, borderWidth: 1 }}, interaction: { mode: 'index', intersect: false } };
            const lineChartData = { labels: timeSeries?.labels || [], datasets: [{ label: 'Lượt khách vào', data: timeSeries?.data || [], backgroundColor: 'rgba(59, 130, 246, 0.1)', borderColor: '#3B82F6', borderWidth: 2, pointBackgroundColor: '#3B82F6', fill: true, tension: 0.4 }] };
            trafficChart = initOrUpdateChart(trafficChart, ui.chartCanvas, 'line', lineChartData, lineChartOptions);

            // Update Donut Chart
            const pieColors = ['#3b82f6', '#ef4444', '#22c55e', '#f97316', '#8b5cf6', '#ec4899'];
            const donutChartOptions = { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { position: 'bottom', labels: { color: colors.ticks, usePointStyle: true, } }, tooltip: { backgroundColor: colors.tooltipBg, titleColor: colors.tooltipText, bodyColor: colors.tooltipText, callbacks: { label: (c) => `${c.label}: ${c.raw.toLocaleString('vi-VN')} (${(c.raw / c.chart.getDatasetMeta(0).total * 100).toFixed(1)}%)` } } } };
            const donutChartData = { labels: distribution?.labels || [], datasets: [{ data: distribution?.data || [], backgroundColor: pieColors, borderColor: colors.tooltipBg, borderWidth: 2, }] };
            storeComparisonChart = initOrUpdateChart(storeComparisonChart, ui.storeComparisonCanvas, 'doughnut', donutChartData, donutChartOptions);
        }

        // --- EVENT LISTENERS ---
        ui.filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                ui.filterButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                currentPeriod = button.dataset.period;
                updateDashboard();
            });
        });

        [ui.dateSelector, ui.storeSelector].forEach(el => el.addEventListener('change', updateDashboard));

        // --- INITIALIZATION ---
        ui.dateSelector.value = formatDate(new Date());
        populateStoreSelector();
        setupNotifications();
        setupPopups();
        updateDashboard();
    });
    </script>
</body>
</html>
