<script>
    document.addEventListener('DOMContentLoaded', async () => {
        // --- UI ELEMENT REFERENCES ---
        const ui = {
            loadingIndicator: document.getElementById('loading-indicator'),
            chartCanvas: document.getElementById('trafficChart'),
            storeComparisonCanvas: document.getElementById('storeComparisonChart'),
            filterButtons: document.querySelectorAll('.filter-btn'),
            timeRangeDisplay: document.getElementById('time-range-display'),
            totalInDisplay: document.getElementById('total-in'),
            averageInDisplay: document.getElementById('average-in'),
            peakTimeDisplay: document.getElementById('peak-time'),
            occupancyDisplay: document.getElementById('occupancy'),
            busiestStoreDisplay: document.getElementById('busiest-store'),
            growthDisplay: document.getElementById('growth'),
            storeSelector: document.getElementById('store-selector'),
            datePickerContainer: document.getElementById('date-picker-container'),
            tableContainer: document.getElementById('table-container'),
            downloadCsvButton: document.getElementById('download-csv-button'),
            notification: {
                bell: document.getElementById('notification-bell'),
                badge: document.getElementById('notification-badge'),
                panel: document.getElementById('notification-panel'),
                logContainer: document.getElementById('error-log-container')
            },
        };

        let trafficChart, storeComparisonChart;
        let currentPeriod = 'day';
        let currentTableData = { labels: [], data: [] };
        let stores = [];

        // --- API CALLS ---
        const showLoader = (show) => {
            ui.loadingIndicator.classList.toggle('hidden', !show);
        };

        async function fetchAPI(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error("Fetch API Error:", error);
                return null;
            }
        }
        
        async function fetchStores() {
            return await fetchAPI('/api/stores');
        }

        async function fetchErrorLogs() {
            return await fetchAPI('/api/error-logs');
        }

        async function fetchDashboardData(params) {
            const queryString = new URLSearchParams(params).toString();
            return await fetchAPI(`/api/dashboard-data?${queryString}`);
        }

        // --- HELPER FUNCTIONS ---
        const formatDate = (date, locale = 'sv-SE') => {
            if (!(date instanceof Date)) date = new Date(date);
            return new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
        };

        const getWeekDateRange = (year, week) => {
            const d = new Date(Date.UTC(year, 0, 1 + (week - 1) * 7));
            const day = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 1 - day);
            const startDate = new Date(d);
            const endDate = new Date(d);
            endDate.setUTCDate(d.getUTCDate() + 6);
            return { startDate, endDate };
        };

        // --- UI POPULATION & INTERACTION ---
        function populateStoreSelector(storeData) {
            if (!storeData) return;
            stores = storeData;
            ui.storeSelector.innerHTML = `<option value="all">Tất cả cửa</option>`;
            stores.forEach(store => {
                ui.storeSelector.innerHTML += `<option value="${store.name}">${store.name}</option>`;
            });
        }

        function renderDatePickers() {
            const now = new Date();
            let currentYear = now.getFullYear();
            let html = '';
            const baseClasses = "h-10 custom-select bg-white dark:bg-gray-700 border border-slate-300 dark:border-gray-600 rounded-lg px-3 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none";
            const yearOptions = Array.from({ length: 5 }, (_, i) => `<option value="${currentYear - i}">${currentYear - i}</option>`).join('');

            switch (currentPeriod) {
                case 'day':
                    html = `<input type="date" id="day-selector" class="${baseClasses} w-full sm:w-40" value="${formatDate(now)}">`;
                    break;
                case 'week':
                     const weeksInYear = 52;
                    let weekOptions = '';
                    for(let i=1; i<=weeksInYear; i++) {
                        const {startDate, endDate} = getWeekDateRange(currentYear, i);
                        weekOptions += `<option value="${i}">Tuần ${i} (${formatDate(startDate, 'vi-VN')} - ${formatDate(endDate, 'vi-VN')})</option>`;
                    }
                    html = `<select id="year-selector-week" class="${baseClasses} w-24">${yearOptions}</select><select id="week-selector" class="${baseClasses} w-64">${weekOptions}</select>`;
                    break;
                case 'month':
                    const monthOptions = Array.from({ length: 12 }, (_, i) => `<option value="${i + 1}" ${now.getMonth() === i ? 'selected' : ''}>Tháng ${i + 1}</option>`).join('');
                    html = `<select id="year-selector-month" class="${baseClasses} w-24">${yearOptions}</select><select id="month-selector" class="${baseClasses} w-32">${monthOptions}</select>`;
                    break;
                case 'year':
                    html = `<select id="year-selector-year" class="${baseClasses} w-32">${yearOptions}</select>`;
                    break;
            }
            ui.datePickerContainer.innerHTML = html;
            ui.datePickerContainer.querySelectorAll('select, input').forEach(el => el.addEventListener('change', updateDashboard));
        }

        function setupNotifications(errorLogs) {
            if (!errorLogs || errorLogs.length === 0) {
                ui.notification.badge.classList.add('hidden');
                ui.notification.logContainer.innerHTML = `<div class="text-center text-slate-500 dark:text-slate-400 p-4">Không có cảnh báo nào.</div>`;
                return;
            }
            
            ui.notification.badge.textContent = errorLogs.length;
            ui.notification.badge.classList.remove('hidden');

            ui.notification.logContainer.innerHTML = errorLogs.map(log => {
                return `<div class="flex items-start gap-3 p-3 mx-2 mb-2 bg-red-500/10 border-l-4 border-red-500 rounded-r-lg">
                    <div class="flex-shrink-0 pt-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-4a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd" /></svg></div>
                    <div>
                        <p class="font-semibold text-sm text-slate-800 dark:text-white">${log.error_message} - ${log.store_name}</p>
                        <p class="text-xs text-slate-500 dark:text-slate-400">${new Date(log.log_time).toLocaleString('vi-VN')}</p>
                    </div>
                </div>`;
            }).join('');
        }

        function setupPopups() {
            const setupPopup = (button, panel) => { button.addEventListener('click', (e) => { e.stopPropagation(); panel.classList.toggle('hidden'); }); };
            setupPopup(ui.notification.bell, ui.notification.panel);
            document.addEventListener('click', (e) => {
                if (!ui.notification.panel.classList.contains('hidden') && !ui.notification.panel.contains(e.target) && !ui.notification.bell.contains(e.target)) {
                    ui.notification.panel.classList.add('hidden');
                }
            });
        }

        // --- DATA & CHARTING ---
        function renderDataTable(labels, data) {
            currentTableData = { labels, data };
            let header = 'Thời gian';
            switch(currentPeriod) {
                case 'day': header = 'Giờ'; break;
                case 'week': header = 'Ngày trong tuần'; break;
                case 'month': header = 'Ngày'; break;
                case 'year': header = 'Tháng'; break;
            }

            const tableRows = data.map((currentValue, index) => {
                return `
                <tr class="border-b border-slate-200 dark:border-gray-700 hover:bg-slate-50 dark:hover:bg-gray-700/50">
                    <td class="p-3 text-sm text-slate-700 dark:text-slate-300">${labels[index]}</td>
                    <td class="p-3 text-sm font-medium text-slate-900 dark:text-white text-right">${currentValue.toLocaleString('vi-VN')}</td>
                </tr>`;
            }).join('');

            const tableHTML = `
                <table class="w-full text-left">
                    <thead class="bg-slate-100 dark:bg-gray-700 sticky top-0 z-10">
                        <tr>
                            <th class="p-3 text-sm font-semibold text-slate-600 dark:text-slate-300">${header}</th>
                            <th class="p-3 text-sm font-semibold text-slate-600 dark:text-slate-300 text-right">Lượt vào</th>
                        </tr>
                    </thead>
                    <tbody>${tableRows}</tbody>
                </table>`;
            ui.tableContainer.innerHTML = tableRows.length > 0 ? tableHTML : `<div class="p-4 text-center text-slate-500">Không có dữ liệu.</div>`;
        }

        function getChartColors() {
            const isDark = document.documentElement.classList.contains('dark');
            return {
                grid: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)',
                ticks: isDark ? '#94a3b8' : '#64748b',
                tooltipBg: isDark ? '#1e293b' : '#ffffff',
                tooltipText: isDark ? '#f1f5f9' : '#1e293b'
            };
        }

        function initOrUpdateLineChart(chartData) {
            const colors = getChartColors();
            const chartOptions = { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: colors.grid }, ticks: { color: colors.ticks } }, x: { grid: { display: false }, ticks: { color: colors.ticks } } }, plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false, backgroundColor: colors.tooltipBg, titleColor: colors.tooltipText, bodyColor: colors.tooltipText, titleFont: { weight: 'bold' }, bodySpacing: 4, padding: 12, cornerRadius: 8, borderColor: colors.grid, borderWidth: 1 }}, interaction: { mode: 'index', intersect: false } };
            
            if (trafficChart) {
                trafficChart.data.labels = chartData.map(d => d.label);
                trafficChart.data.datasets[0].data = chartData.map(d => d.value);
                trafficChart.options = chartOptions;
                trafficChart.update('none');
            } else {
                const ctx = ui.chartCanvas.getContext('2d');
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)');
                gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');
                trafficChart = new Chart(ctx, { type: 'line', data: { labels: chartData.map(d => d.label), datasets: [{ label: 'Lượt khách vào', data: chartData.map(d => d.value), backgroundColor: gradient, borderColor: '#3B82F6', borderWidth: 2, pointBackgroundColor: '#3B82F6', pointHoverRadius: 6, pointHoverBorderColor: '#fff', fill: true, tension: 0.4 }] }, options: chartOptions });
            }
        }

        function initOrUpdateDonutChart(pieData) {
            const colors = getChartColors();
            const pieColors = ['#3b82f6', '#ef4444', '#22c55e', '#f97316', '#8b5cf6', '#ec4899'];
            const chartOptions = { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { position: 'bottom', labels: { color: colors.ticks, usePointStyle: true, } }, tooltip: { backgroundColor: colors.tooltipBg, titleColor: colors.tooltipText, bodyColor: colors.tooltipText, callbacks: { label: (c) => `${c.label}: ${c.raw.toLocaleString('vi-VN')} (${(c.raw / c.chart.getDatasetMeta(0).total * 100).toFixed(1)}%)` } } } };

            if (storeComparisonChart) {
                storeComparisonChart.data.labels = pieData.labels;
                storeComparisonChart.data.datasets[0].data = pieData.data;
                storeComparisonChart.options = chartOptions;
                storeComparisonChart.update('none');
            } else {
                storeComparisonChart = new Chart(ui.storeComparisonCanvas.getContext('2d'), { type: 'doughnut', data: { labels: pieData.labels, datasets: [{ label: 'Lượt vào', data: pieData.data, backgroundColor: pieColors, borderColor: colors.tooltipBg, borderWidth: 2, }] }, options: chartOptions });
            }
        }

        async function updateDashboard() {
            showLoader(true);
            
            const storeId = ui.storeSelector.value;
            let startDate, endDate;

            switch (currentPeriod) {
                case 'day':
                    const selectedDay = document.getElementById('day-selector').value;
                    startDate = new Date(selectedDay);
                    endDate = new Date(selectedDay);
                    break;
                case 'week':
                    const year_w = document.getElementById('year-selector-week').value;
                    const week = document.getElementById('week-selector').value;
                    ({ startDate, endDate } = getWeekDateRange(year_w, week));
                    break;
                case 'month':
                    const year_m = document.getElementById('year-selector-month').value;
                    const month = document.getElementById('month-selector').value;
                    startDate = new Date(year_m, month - 1, 1);
                    endDate = new Date(year_m, month, 0);
                    break;
                case 'year':
                    const year = document.getElementById('year-selector-year').value;
                    startDate = new Date(year, 0, 1);
                    endDate = new Date(year, 11, 31);
                    break;
            }

            const params = {
                period: currentPeriod,
                store_id: storeId,
                start_date: formatDate(startDate),
                end_date: formatDate(endDate)
            };

            const data = await fetchDashboardData(params);
            
            if (data) {
                const metrics = data.metrics;
                ui.totalInDisplay.textContent = metrics.total_in.toLocaleString('vi-VN');
                ui.averageInDisplay.textContent = metrics.average_in.toLocaleString('vi-VN', { maximumFractionDigits: 0 });
                ui.peakTimeDisplay.textContent = metrics.peak_time;
                ui.occupancyDisplay.textContent = metrics.occupancy.toLocaleString('vi-VN');
                ui.busiestStoreDisplay.textContent = metrics.busiest_store;
                ui.busiestStoreDisplay.title = metrics.busiest_store;

                const growth = metrics.growth_percentage;
                const growthColor = growth > 0 ? 'text-green-500' : growth < 0 ? 'text-red-500' : 'text-slate-500';
                const growthIcon = growth > 0 ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>` : growth < 0 ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12" /></svg>` : '';
                ui.growthDisplay.className = `text-2xl xl:text-3xl font-bold mt-1 flex items-center gap-2 ${growthColor}`;
                ui.growthDisplay.innerHTML = `<span>${growth.toFixed(1)}%</span> ${growthIcon}`;

                initOrUpdateLineChart(data.line_chart_data);
                initOrUpdateDonutChart(data.store_comparison_data);

                renderDataTable(data.table_data.map(d => d.label), data.table_data.map(d => d.value));
                ui.timeRangeDisplay.textContent = `${formatDate(startDate, 'vi-VN')} - ${formatDate(endDate, 'vi-VN')}`;
            } else {
                // Handle API error
                ui.totalInDisplay.textContent = 'Lỗi';
                ui.averageInDisplay.textContent = 'Lỗi';
                ui.peakTimeDisplay.textContent = '--';
                // ... clear other fields
                initOrUpdateLineChart([]);
                initOrUpdateDonutChart({labels: [], data: []});
                renderDataTable([], []);
            }

            showLoader(false);
        }

        function downloadTableAsCSV() {
            const { labels, data } = currentTableData;
            if (labels.length === 0) return;

            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            const header = currentPeriod === 'day' ? 'Giờ' : currentPeriod === 'week' ? 'Ngày trong tuần' : currentPeriod === 'month' ? 'Ngày' : 'Tháng';
            csvContent += `"${header}","Lượt vào"\r\n`;

            data.forEach((value, index) => {
                csvContent += `"${labels[index]}","${value}"\r\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `du_lieu_chi_tiet_${formatDate(new Date())}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- EVENT LISTENERS ---
        ui.filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                ui.filterButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                currentPeriod = button.dataset.period;
                renderDatePickers();
                updateDashboard();
            });
        });
        ui.storeSelector.addEventListener('change', updateDashboard);
        ui.downloadCsvButton.addEventListener('click', downloadTableAsCSV);

        // --- INITIALIZATION ---
        async function initialize() {
            showLoader(true);
            renderDatePickers();
            setupPopups();
            const [storeData, errorData] = await Promise.all([
                fetchStores(),
                fetchErrorLogs()
            ]);
            populateStoreSelector(storeData);
            setupNotifications(errorData);
            await updateDashboard();
            showLoader(false);
        }

        initialize();
    });
</script>





    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // --- UI ELEMENT REFERENCES ---
            const ui = {
                loadingIndicator: document.getElementById('loading-indicator'),
                chartCanvas: document.getElementById('trafficChart'),
                storeComparisonCanvas: document.getElementById('storeComparisonChart'),
                filterButtons: document.querySelectorAll('.filter-btn'),
                timeRangeDisplay: document.getElementById('time-range-display'),
                totalInDisplay: document.getElementById('total-in'),
                averageInDisplay: document.getElementById('average-in'),
                peakTimeDisplay: document.getElementById('peak-time'),
                occupancyDisplay: document.getElementById('occupancy'),
                busiestStoreDisplay: document.getElementById('busiest-store'),
                growthDisplay: document.getElementById('growth'),
                storeSelector: document.getElementById('store-selector'),
                datePickerContainer: document.getElementById('date-picker-container'),
                tableContainer: document.getElementById('table-container'),
                downloadCsvButton: document.getElementById('download-csv-button'),
                notification: {
                    bell: document.getElementById('notification-bell'),
                    badge: document.getElementById('notification-badge'),
                    panel: document.getElementById('notification-panel'),
                    logContainer: document.getElementById('error-log-container')
                },
            };

            let trafficChart, storeComparisonChart;
            let currentPeriod = 'day';
            let currentTableData = { labels: [], data: [] };
            let stores = [];

            // --- API CALLS ---
            const showLoader = (show) => {
                ui.loadingIndicator.classList.toggle('hidden', !show);
            };

            async function fetchAPI(url) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error("Fetch API Error:", error);
                    // Hiển thị thông báo lỗi cho người dùng
                    return null;
                }
            }
            
            async function fetchStores() {
                return await fetchAPI('/api/stores');
            }

            async function fetchErrorLogs() {
                return await fetchAPI('/api/error-logs');
            }

            async function fetchDashboardData(params) {
                const queryString = new URLSearchParams(params).toString();
                return await fetchAPI(`/api/dashboard-data?${queryString}`);
            }

            // --- HELPER FUNCTIONS ---
            const formatDate = (date, locale = 'sv-SE') => { // sv-SE for YYYY-MM-DD
                if (!(date instanceof Date)) date = new Date(date);
                return new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
            };

            const getWeekDateRange = (year, week) => {
                const d = new Date(Date.UTC(year, 0, 1 + (week - 1) * 7));
                const day = d.getUTCDay() || 7;
                d.setUTCDate(d.getUTCDate() + 1 - day);
                const startDate = new Date(d);
                const endDate = new Date(d);
                endDate.setUTCDate(d.getUTCDate() + 6);
                return { startDate, endDate };
            };

            // --- UI POPULATION & INTERACTION ---
            function populateStoreSelector(storeData) {
                if (!storeData) return;
                stores = storeData; // Lưu lại danh sách cửa hàng
                ui.storeSelector.innerHTML = `<option value="all">Tất cả cửa</option>`;
                stores.forEach(store => {
                    ui.storeSelector.innerHTML += `<option value="${store.name}">${store.name}</option>`;
                });
            }

            function renderDatePickers() {
                const now = new Date();
                let currentYear = now.getFullYear();
                let html = '';
                const baseClasses = "h-10 custom-select bg-white dark:bg-gray-700 border border-slate-300 dark:border-gray-600 rounded-lg px-3 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none";
                const yearOptions = Array.from({ length: 5 }, (_, i) => `<option value="${currentYear - i}">${currentYear - i}</option>`).join('');

                switch (currentPeriod) {
                    case 'day':
                        html = `<input type="date" id="day-selector" class="${baseClasses} w-full sm:w-40" value="${formatDate(now)}">`;
                        break;
                    case 'week':
                         const weeksInYear = 52;
                        let weekOptions = '';
                        for(let i=1; i<=weeksInYear; i++) {
                            const {startDate, endDate} = getWeekDateRange(currentYear, i);
                            weekOptions += `<option value="${i}">Tuần ${i} (${formatDate(startDate, 'vi-VN')} - ${formatDate(endDate, 'vi-VN')})</option>`;
                        }
                        html = `<select id="year-selector-week" class="${baseClasses} w-24">${yearOptions}</select><select id="week-selector" class="${baseClasses} w-64">${weekOptions}</select>`;
                        break;
                    case 'month':
                        const monthOptions = Array.from({ length: 12 }, (_, i) => `<option value="${i + 1}" ${now.getMonth() === i ? 'selected' : ''}>Tháng ${i + 1}</option>`).join('');
                        html = `<select id="year-selector-month" class="${baseClasses} w-24">${yearOptions}</select><select id="month-selector" class="${baseClasses} w-32">${monthOptions}</select>`;
                        break;
                    case 'year':
                        html = `<select id="year-selector-year" class="${baseClasses} w-32">${yearOptions}</select>`;
                        break;
                }
                ui.datePickerContainer.innerHTML = html;
                ui.datePickerContainer.querySelectorAll('select, input').forEach(el => el.addEventListener('change', updateDashboard));
            }

            function setupNotifications(errorLogs) {
                if (!errorLogs || errorLogs.length === 0) {
                    ui.notification.badge.classList.add('hidden');
                    ui.notification.logContainer.innerHTML = `<div class="text-center text-slate-500 dark:text-slate-400 p-4">Không có cảnh báo nào.</div>`;
                    return;
                }
                
                ui.notification.badge.textContent = errorLogs.length;
                ui.notification.badge.classList.remove('hidden');

                ui.notification.logContainer.innerHTML = errorLogs.map(log => {
                    return `<div class="flex items-start gap-3 p-3 mx-2 mb-2 bg-red-500/10 border-l-4 border-red-500 rounded-r-lg">
                        <div class="flex-shrink-0 pt-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-4a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd" /></svg></div>
                        <div>
                            <p class="font-semibold text-sm text-slate-800 dark:text-white">${log.error_message} - ${log.store_name}</p>
                            <p class="text-xs text-slate-500 dark:text-slate-400">${new Date(log.log_time).toLocaleString('vi-VN')}</p>
                        </div>
                    </div>`;
                }).join('');
            }

            function setupPopups() {
                const setupPopup = (button, panel) => { button.addEventListener('click', (e) => { e.stopPropagation(); panel.classList.toggle('hidden'); }); };
                setupPopup(ui.notification.bell, ui.notification.panel);
                document.addEventListener('click', (e) => {
                    if (!ui.notification.panel.classList.contains('hidden') && !ui.notification.panel.contains(e.target) && !ui.notification.bell.contains(e.target)) {
                        ui.notification.panel.classList.add('hidden');
                    }
                });
            }

            // --- DATA & CHARTING ---
            function renderDataTable(labels, data) {
                currentTableData = { labels, data };
                let header = 'Thời gian';
                switch(currentPeriod) {
                    case 'day': header = 'Giờ'; break;
                    case 'week': header = 'Ngày trong tuần'; break;
                    case 'month': header = 'Ngày'; break;
                    case 'year': header = 'Tháng'; break;
                }

                const tableRows = data.map((currentValue, index) => {
                    return `
                    <tr class="border-b border-slate-200 dark:border-gray-700 hover:bg-slate-50 dark:hover:bg-gray-700/50">
                        <td class="p-3 text-sm text-slate-700 dark:text-slate-300">${labels[index]}</td>
                        <td class="p-3 text-sm font-medium text-slate-900 dark:text-white text-right">${currentValue.toLocaleString('vi-VN')}</td>
                    </tr>`;
                }).join('');

                const tableHTML = `
                    <table class="w-full text-left">
                        <thead class="bg-slate-100 dark:bg-gray-700 sticky top-0 z-10">
                            <tr>
                                <th class="p-3 text-sm font-semibold text-slate-600 dark:text-slate-300">${header}</th>
                                <th class="p-3 text-sm font-semibold text-slate-600 dark:text-slate-300 text-right">Lượt vào</th>
                            </tr>
                        </thead>
                        <tbody>${tableRows}</tbody>
                    </table>`;
                ui.tableContainer.innerHTML = tableRows ? tableHTML : `<div class="p-4 text-center text-slate-500">Không có dữ liệu.</div>`;
            }

            function getChartColors() {
                const isDark = document.documentElement.classList.contains('dark');
                return {
                    grid: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)',
                    ticks: isDark ? '#94a3b8' : '#64748b',
                    tooltipBg: isDark ? '#1e293b' : '#ffffff',
                    tooltipText: isDark ? '#f1f5f9' : '#1e293b'
                };
            }

            function initOrUpdateLineChart(chartData) {
                const colors = getChartColors();
                const chartOptions = { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: colors.grid }, ticks: { color: colors.ticks } }, x: { grid: { display: false }, ticks: { color: colors.ticks } } }, plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false, backgroundColor: colors.tooltipBg, titleColor: colors.tooltipText, bodyColor: colors.tooltipText, titleFont: { weight: 'bold' }, bodySpacing: 4, padding: 12, cornerRadius: 8, borderColor: colors.grid, borderWidth: 1 }}, interaction: { mode: 'index', intersect: false } };
                
                if (trafficChart) {
                    trafficChart.data.labels = chartData.map(d => d.label);
                    trafficChart.data.datasets[0].data = chartData.map(d => d.value);
                    trafficChart.options = chartOptions;
                    trafficChart.update('none');
                } else {
                    const ctx = ui.chartCanvas.getContext('2d');
                    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                    gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)');
                    gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');
                    trafficChart = new Chart(ctx, { type: 'line', data: { labels: chartData.map(d => d.label), datasets: [{ label: 'Lượt khách vào', data: chartData.map(d => d.value), backgroundColor: gradient, borderColor: '#3B82F6', borderWidth: 2, pointBackgroundColor: '#3B82F6', pointHoverRadius: 6, pointHoverBorderColor: '#fff', fill: true, tension: 0.4 }] }, options: chartOptions });
                }
            }

            function initOrUpdateDonutChart(pieData) {
                const colors = getChartColors();
                const pieColors = ['#3b82f6', '#ef4444', '#22c55e', '#f97316', '#8b5cf6', '#ec4899'];
                const chartOptions = { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { position: 'bottom', labels: { color: colors.ticks, usePointStyle: true, } }, tooltip: { backgroundColor: colors.tooltipBg, titleColor: colors.tooltipText, bodyColor: colors.tooltipText, callbacks: { label: (c) => `${c.label}: ${c.raw.toLocaleString('vi-VN')} (${(c.raw / c.chart.getDatasetMeta(0).total * 100).toFixed(1)}%)` } } } };

                if (storeComparisonChart) {
                    storeComparisonChart.data.labels = pieData.labels;
                    storeComparisonChart.data.datasets[0].data = pieData.data;
                    storeComparisonChart.options = chartOptions;
                    storeComparisonChart.update('none');
                } else {
                    storeComparisonChart = new Chart(ui.storeComparisonCanvas.getContext('2d'), { type: 'doughnut', data: { labels: pieData.labels, datasets: [{ label: 'Lượt vào', data: pieData.data, backgroundColor: pieColors, borderColor: colors.tooltipBg, borderWidth: 2, }] }, options: chartOptions });
                }
            }

            async function updateDashboard() {
                showLoader(true);
                
                // 1. Get current filter values
                const storeId = ui.storeSelector.value;
                let startDate, endDate;
                const now = new Date();

                switch (currentPeriod) {
                    case 'day':
                        const selectedDay = document.getElementById('day-selector').value;
                        startDate = new Date(selectedDay);
                        endDate = new Date(selectedDay);
                        break;
                    case 'week':
                        const year_w = document.getElementById('year-selector-week').value;
                        const week = document.getElementById('week-selector').value;
                        ({ startDate, endDate } = getWeekDateRange(year_w, week));
                        break;
                    case 'month':
                        const year_m = document.getElementById('year-selector-month').value;
                        const month = document.getElementById('month-selector').value;
                        startDate = new Date(year_m, month - 1, 1);
                        endDate = new Date(year_m, month, 0);
                        break;
                    case 'year':
                        const year = document.getElementById('year-selector-year').value;
                        startDate = new Date(year, 0, 1);
                        endDate = new Date(year, 11, 31);
                        break;
                }

                const params = {
                    period: currentPeriod,
                    store_id: storeId,
                    start_date: formatDate(startDate),
                    end_date: formatDate(endDate)
                };

                // 2. Fetch data from backend
                const data = await fetchDashboardData(params);
                
                // 3. Update UI with fetched data
                if (data) {
                    // Update metrics
                    const metrics = data.metrics;
                    ui.totalInDisplay.textContent = metrics.total_in.toLocaleString('vi-VN');
                    ui.averageInDisplay.textContent = metrics.average_in.toLocaleString('vi-VN', { maximumFractionDigits: 0 });
                    ui.peakTimeDisplay.textContent = metrics.peak_time;
                    ui.occupancyDisplay.textContent = metrics.occupancy.toLocaleString('vi-VN');
                    ui.busiestStoreDisplay.textContent = metrics.busiest_store;
                    ui.busiestStoreDisplay.title = metrics.busiest_store;

                    const growth = metrics.growth_percentage;
                    const growthColor = growth > 0 ? 'text-green-500' : growth < 0 ? 'text-red-500' : 'text-slate-500';
                    const growthIcon = growth > 0 ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>` : growth < 0 ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12" /></svg>` : '';
                    ui.growthDisplay.className = `text-2xl xl:text-3xl font-bold mt-1 flex items-center gap-2 ${growthColor}`;
                    ui.growthDisplay.innerHTML = `<span>${growth.toFixed(1)}%</span> ${growthIcon}`;

                    // Update charts
                    initOrUpdateLineChart(data.line_chart_data);
                    initOrUpdateDonutChart(data.store_comparison_data);

                    // Update table
                    renderDataTable(data.table_data.map(d => d.label), data.table_data.map(d => d.value));
                    ui.timeRangeDisplay.textContent = `${formatDate(startDate, 'vi-VN')} - ${formatDate(endDate, 'vi-VN')}`;
                } else {
                    // Handle case where data is null (API error)
                    // Clear all data displays
                    ui.totalInDisplay.textContent = 'Lỗi';
                    // ... clear other fields
                    initOrUpdateLineChart([]);
                    initOrUpdateDonutChart({labels: [], data: []});
                    renderDataTable([], []);
                }

                showLoader(false);
            }

            function downloadTableAsCSV() {
                const { labels, data } = currentTableData;
                if (labels.length === 0) return;

                let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // BOM for Vietnamese in Excel
                const header = currentPeriod === 'day' ? 'Giờ' : currentPeriod === 'week' ? 'Ngày trong tuần' : currentPeriod === 'month' ? 'Ngày' : 'Tháng';
                csvContent += `"${header}","Lượt vào"\r\n`;

                data.forEach((value, index) => {
                    csvContent += `"${labels[index]}","${value}"\r\n`;
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `du_lieu_chi_tiet_${formatDate(new Date())}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // --- EVENT LISTENERS ---
            ui.filterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    ui.filterButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    currentPeriod = button.dataset.period;
                    renderDatePickers();
                    updateDashboard();
                });
            });
            ui.storeSelector.addEventListener('change', updateDashboard);
            ui.downloadCsvButton.addEventListener('click', downloadTableAsCSV);

            // --- INITIALIZATION ---
            async function initialize() {
                showLoader(true);
                renderDatePickers();
                setupPopups();
                const [storeData, errorData] = await Promise.all([
                    fetchStores(),
                    fetchErrorLogs()
                ]);
                populateStoreSelector(storeData);
                setupNotifications(errorData);
                await updateDashboard();
                showLoader(false);
            }

            initialize();
        });
    </script>
